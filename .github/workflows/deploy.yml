name: ğŸš€ Deploy Greenscape

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-greenscape
  cancel-in-progress: false

env:
  APP_NAME: ${{ secrets.APP_NAME || 'greenscape' }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.AR_REGION || 'us-central1' }}
  REPOSITORY: ${{ secrets.AR_REPO_NAME || 'greenscape' }}

jobs:
  deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: â˜ï¸ Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ğŸ³ Configure Docker
      run: |
        echo "ğŸ³ Configuring Docker for Artifact Registry..."
        DOCKER_REGION="${{ env.REGION }}"
        if [ -z "$DOCKER_REGION" ]; then
          DOCKER_REGION="us-central1"
        fi
        echo "Docker registry: $DOCKER_REGION-docker.pkg.dev"
        gcloud auth configure-docker $DOCKER_REGION-docker.pkg.dev --quiet
        echo "DOCKER_REGION=$DOCKER_REGION" >> $GITHUB_ENV

    - name: ğŸ“¦ Fetch Environment Variables
      run: |
        echo "ğŸ“¦ Fetching environment from Secret Manager..."
        echo "Project: ${{ env.PROJECT_ID }}"
        echo "Secret: greenscape"

        gcloud secrets versions access latest \
          --secret="greenscape" \
          --project="${{ env.PROJECT_ID }}" > .env.production

        echo "âœ… Environment variables fetched from Secret Manager"
        echo "ğŸ“Š File size: $(wc -c < .env.production) bytes"
        echo "ğŸ“Š Line count: $(wc -l < .env.production) lines"
        echo "ğŸ” First 10 variable names:"
        head -10 .env.production | cut -d'=' -f1
        echo "ğŸ” Looking for VITE_SITE_TITLE:"
        grep "VITE_SITE_TITLE" .env.production || echo "âŒ VITE_SITE_TITLE not found!"

    - name: ğŸ—ï¸ Build & Push Docker Image
      run: |
        APP_NAME_LOWER=$(echo "${{ env.APP_NAME }}" | tr '[:upper:]' '[:lower:]')
        IMAGE_PATH="${{ env.DOCKER_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/$APP_NAME_LOWER"

        echo "ğŸ—ï¸ Building Docker image: $IMAGE_PATH"

        # Copy .env.production to .env for the build context
        cp .env.production .env

        echo "ğŸ” Verifying .env file for Docker build:"
        echo "ğŸ“Š .env size: $(wc -c < .env) bytes"
        echo "ğŸ“Š .env lines: $(wc -l < .env) lines"
        echo "ğŸ” First 5 variables in .env:"
        head -5 .env
        echo "ğŸ” VITE_SITE_TITLE check:"
        grep "VITE_SITE_TITLE" .env || echo "âŒ VITE_SITE_TITLE missing in .env!"
        echo "ğŸ” All VITE_ variables:"
        grep "^VITE_" .env | wc -l | xargs -I {} echo "Found {} VITE_ variables"

        echo "ğŸ³ Starting Docker build with .env file..."
        docker build \
          --build-arg NODE_ENV=production \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "ğŸ“¤ Pushing images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "IMAGE_PATH=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Setup VM Directories
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          mkdir -p ~/projects/greenacape-app
          chown -R $USER:$USER ~/projects/greenacape-app

    - name: ğŸ“¤ Upload Files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        source: "docker-compose.yml"
        target: ~/projects/greenacape-app/

    - name: ğŸ“¦ Create .env file on VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          echo "ğŸ“¦ Creating .env file on VM from Secret Manager..."
          gcloud secrets versions access latest \
            --secret="greenscape" \
            --project="${{ env.PROJECT_ID }}" > ~/projects/greenacape-app/.env

          echo "âœ… .env file created from Secret Manager"
          echo "ğŸ” VM .env file verification:"
          echo "ğŸ“Š Size: $(wc -c < ~/projects/greenacape-app/.env) bytes"
          echo "ğŸ“Š Lines: $(wc -l < ~/projects/greenacape-app/.env) lines"
          echo "ğŸ” First 5 variables:"
          head -5 ~/projects/greenacape-app/.env
          echo "ğŸ” VITE_SITE_TITLE check:"
          grep "VITE_SITE_TITLE" ~/projects/greenacape-app/.env || echo "âŒ VITE_SITE_TITLE missing!"
          echo "ğŸ” Total VITE_ variables:"
          grep "^VITE_" ~/projects/greenacape-app/.env | wc -l | xargs -I {} echo "Found {} VITE_ variables"

    - name: ğŸš€ Deploy Application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          cd ~/projects/greenacape-app

          # Authenticate with GCP
          if [ -f ~/.gcp/service-account-key.json ]; then
            gcloud auth activate-service-account --key-file=~/.gcp/service-account-key.json
          fi
          gcloud auth configure-docker ${{ env.DOCKER_REGION }}-docker.pkg.dev --quiet

          # Ensure Docker network exists
          docker network inspect web >/dev/null 2>&1 || docker network create web

          # Update image path in compose file
          sed -i "s|image: .*|image: ${{ env.IMAGE_PATH }}:${{ github.sha }}|g" docker-compose.yml

          # Deploy
          docker compose pull
          docker compose up -d --force-recreate

          # Ensure container is on web network
          docker network connect web greenacape-frontend 2>/dev/null || echo "Container already on web network"

    - name: ğŸ” Health Check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          sleep 15
          curl -f -m 10 http://localhost:3000/ && echo "âœ… Frontend OK" || echo "âŒ Frontend FAIL"
          docker logs greenacape-frontend --tail 20