name: ğŸš€ Deploy Greenscape

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-greenscape
  cancel-in-progress: false

env:
  APP_NAME: ${{ secrets.APP_NAME || 'greenscape' }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'vernal-seeker-472512-i5' }}
  REGION: ${{ secrets.AR_REGION || 'us-central1' }}
  REPOSITORY: ${{ secrets.AR_REPO_NAME || 'greenscape' }}

jobs:
  deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: â˜ï¸ Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ğŸ³ Configure Docker
      run: |
        echo "ğŸ³ Configuring Docker for Artifact Registry..."
        DOCKER_REGION="${{ env.REGION }}"
        if [ -z "$DOCKER_REGION" ]; then
          DOCKER_REGION="us-central1"
        fi
        echo "Docker registry: $DOCKER_REGION-docker.pkg.dev"
        gcloud auth configure-docker $DOCKER_REGION-docker.pkg.dev --quiet
        echo "DOCKER_REGION=$DOCKER_REGION" >> $GITHUB_ENV

    - name: ğŸ“¦ Prepare Environment Variables
      run: |
        echo "ğŸ“¦ Using local .env file for deployment..."

        # Copy local .env to .env.production
        cp .env .env.production

        echo "âœ… Environment variables prepared from local .env"
        echo "ğŸ“Š File size: $(wc -c < .env.production) bytes"
        echo "ğŸ“Š Line count: $(wc -l < .env.production) lines"
        echo "ğŸ” First 10 variable names:"
        head -10 .env.production | cut -d'=' -f1
        echo "ğŸ” Looking for VITE_SITE_TITLE:"
        grep "VITE_SITE_TITLE" .env.production || echo "âŒ VITE_SITE_TITLE not found!"
        echo "ğŸ” Looking for VITE_SHOWROOM_MEDIA_URL:"
        grep "VITE_SHOWROOM_MEDIA_URL" .env.production || echo "âŒ VITE_SHOWROOM_MEDIA_URL not found!"
        echo "ğŸ” Looking for VITE_MAPS_EMBED_URL:"
        grep "VITE_MAPS_EMBED_URL" .env.production || echo "âŒ VITE_MAPS_EMBED_URL not found!"

    - name: ğŸ—ï¸ Build & Push Docker Image
      run: |
        APP_NAME_LOWER=$(echo "${{ env.APP_NAME }}" | tr '[:upper:]' '[:lower:]')
        IMAGE_PATH="${{ env.DOCKER_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/$APP_NAME_LOWER"

        echo "ğŸ—ï¸ Building Docker image: $IMAGE_PATH"

        # Copy .env.production to .env for the build context
        cp .env.production .env

        echo "ğŸ” COMPREHENSIVE .env VERIFICATION FOR DOCKER BUILD:"
        echo "ğŸ“Š .env size: $(wc -c < .env) bytes"
        echo "ğŸ“Š .env lines: $(wc -l < .env) lines"
        echo "ğŸ” First 10 variables in .env:"
        head -10 .env
        echo "ğŸ” VITE_SITE_TITLE check:"
        grep "VITE_SITE_TITLE" .env || echo "âŒ VITE_SITE_TITLE missing in .env!"
        echo "ğŸ” All VITE_ variables (first 10):"
        grep "^VITE_" .env | head -10
        echo "ğŸ” Total VITE_ variables count:"
        grep "^VITE_" .env | wc -l | xargs -I {} echo "Found {} VITE_ variables"

        echo "ğŸ” .env file permissions:"
        ls -la .env
        echo "ğŸ” Current working directory:"
        pwd
        echo "ğŸ” All files in current directory:"
        ls -la

        echo "ğŸ³ Starting Docker build with .env file..."
        echo "ğŸ” Docker build context verification:"
        echo "ğŸ” Files being copied to Docker context:"
        find . -name ".env*" -type f -exec ls -la {} \;

        docker build \
          --no-cache \
          --pull \
          --build-arg NODE_ENV=production \
          --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
          --build-arg BUILD_SHA=${{ github.sha }} \
          --progress=plain \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "ğŸ” POST-BUILD VERIFICATION:"
        echo "ğŸ” Testing built image environment variables..."
        docker run --rm $IMAGE_PATH:latest /bin/sh -c "
          echo 'ğŸ” Environment variables in built container:';
          env | grep VITE_ | head -10 || echo 'âŒ No VITE_ variables found in container';
          echo 'ğŸ” Checking if .env file exists in container:';
          ls -la /app/.env* 2>/dev/null || echo 'âŒ No .env files found in container';
          echo 'ğŸ” Node.js process.env check:';
          node -e 'console.log(\"VITE_SITE_TITLE:\", process.env.VITE_SITE_TITLE || \"MISSING\")';
        "

        echo "ğŸ“¤ Pushing images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "IMAGE_PATH=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Setup VM Directories
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          mkdir -p ~/projects/greenacape-app
          mkdir -p ~/.gcp
          chown -R $USER:$USER ~/projects/greenacape-app ~/.gcp

    - name: ğŸ” Use Manually Created VM Service Account
      run: |
        echo "ğŸ” Using manually created VM service account for Secret Manager access..."

        VM_SA_EMAIL="vm-secret-manager-access@vernal-seeker-472512-i5.iam.gserviceaccount.com"

        echo "ğŸ” Service account details:"
        echo "Email: $VM_SA_EMAIL"
        echo "Project: vernal-seeker-472512-i5"

        # Verify service account exists and has correct permissions
        echo "ğŸ” Verifying service account exists..."
        if gcloud iam service-accounts describe $VM_SA_EMAIL --project=vernal-seeker-472512-i5 >/dev/null 2>&1; then
          echo "âœ… VM service account exists: $VM_SA_EMAIL"
        else
          echo "âŒ VM service account not found: $VM_SA_EMAIL"
          exit 1
        fi

        # Check permissions
        echo "ğŸ” Checking Secret Manager permissions..."
        gcloud projects get-iam-policy vernal-seeker-472512-i5 \
          --flatten="bindings[].members" \
          --format="table(bindings.role)" \
          --filter="bindings.members:serviceAccount:$VM_SA_EMAIL AND bindings.role:roles/secretmanager.secretAccessor" || echo "âŒ Missing secretmanager.secretAccessor role"

        echo "ğŸ” Checking Artifact Registry permissions..."
        gcloud projects get-iam-policy vernal-seeker-472512-i5 \
          --flatten="bindings[].members" \
          --format="table(bindings.role)" \
          --filter="bindings.members:serviceAccount:$VM_SA_EMAIL AND bindings.role:roles/artifactregistry.reader" || echo "âŒ Missing artifactregistry.reader role"

        # Create service account key file from GitHub secret
        echo "ğŸ”‘ Creating service account key file from GitHub secret..."
        echo '${{ secrets.VM_SA_KEY }}' > vm-service-account-key.json
        echo "âœ… VM service account key file created"
        echo "ğŸ“Š Key file size: $(wc -c < vm-service-account-key.json) bytes"

    - name: ğŸ“¤ Upload Files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        source: "docker-compose.yml,.env.production,vm-service-account-key.json"
        target: ~/projects/greenacape-app/

    - name: ğŸ” Setup VM Service Account
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          echo "ğŸ” Setting up service account key on VM..."
          mv ~/projects/greenacape-app/vm-service-account-key.json ~/.gcp/service-account-key.json
          chmod 600 ~/.gcp/service-account-key.json
          echo "âœ… Service account key moved to ~/.gcp/"

    - name: ğŸ“¦ Create .env file on VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          cd ~/projects/greenacape-app
          echo "ğŸ“¦ Creating .env file on VM from uploaded .env.production..."

          # Use the uploaded .env.production file directly
          cp .env.production .env

          echo "ğŸ” FINAL VM .env FILE VERIFICATION:"
          echo "ğŸ“Š Size: $(wc -c < .env) bytes"
          echo "ğŸ“Š Lines: $(wc -l < .env) lines"
          echo "ğŸ” First 10 variables:"
          head -10 .env
          echo "ğŸ” VITE_SITE_TITLE check:"
          grep "VITE_SITE_TITLE" .env || echo "âŒ VITE_SITE_TITLE missing!"
          echo "ğŸ” VITE_SHOWROOM_MEDIA_URL check:"
          grep "VITE_SHOWROOM_MEDIA_URL" .env || echo "âŒ VITE_SHOWROOM_MEDIA_URL missing!"
          echo "ğŸ” VITE_MAPS_EMBED_URL check:"
          grep "VITE_MAPS_EMBED_URL" .env || echo "âŒ VITE_MAPS_EMBED_URL missing!"
          echo "ğŸ” All VITE_ variables (first 10):"
          grep "^VITE_" .env | head -10
          echo "ğŸ” Total VITE_ variables:"
          grep "^VITE_" .env | wc -l | xargs -I {} echo "Found {} VITE_ variables"
          echo "ğŸ” .env file permissions:"
          ls -la .env
          echo "ğŸ” Working directory contents:"
          ls -la

    - name: ğŸš€ Deploy Application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          cd ~/projects/greenacape-app

          # Authenticate with GCP
          if [ -f ~/.gcp/service-account-key.json ]; then
            gcloud auth activate-service-account --key-file=~/.gcp/service-account-key.json
          fi
          gcloud auth configure-docker ${{ env.DOCKER_REGION }}-docker.pkg.dev --quiet

          # Ensure Docker network exists
          docker network inspect web >/dev/null 2>&1 || docker network create web

          # Update image path in compose file
          sed -i "s|image: .*|image: ${{ env.IMAGE_PATH }}:${{ github.sha }}|g" docker-compose.yml

          # Clean up old containers and images
          echo "ğŸ§¹ Cleaning up old containers..."
          docker compose down --remove-orphans || true

          echo "ğŸ§¹ Removing old images..."
          docker images | grep greenscape | awk '{print $3}' | xargs -r docker rmi -f || true

          # Deploy
          echo "ğŸš€ Pulling latest images..."
          docker compose pull --ignore-pull-failures

          echo "ğŸš€ Starting containers..."
          docker compose up -d --force-recreate --remove-orphans

          # Wait for container to start
          echo "â³ Waiting for container to start..."
          sleep 10

          # Verify container is running
          echo "ğŸ” Container status:"
          docker ps | grep greenacape-frontend || echo "âŒ Container not running"

          # Check container environment variables
          echo "ğŸ” ENVIRONMENT VARIABLES IN RUNNING CONTAINER:"
          docker exec greenacape-frontend /bin/sh -c "
            echo 'ğŸ” All environment variables:';
            env | head -20;
            echo 'ğŸ” VITE_ variables:';
            env | grep VITE_ | head -10 || echo 'âŒ No VITE_ variables in container environment';
            echo 'ğŸ” NODE_ENV:';
            echo \$NODE_ENV;
            echo 'ğŸ” Files in /app:';
            ls -la /app/ | head -10;
            echo 'ğŸ” .env files in container:';
            find /app -name '.env*' -type f -exec ls -la {} \; || echo 'âŒ No .env files found';
          " || echo "âŒ Failed to check container environment"

          # Test the application response
          echo "ğŸ” Testing application response:"
          sleep 5
          curl -s -I http://localhost:3000/ | head -5 || echo "âŒ Application not responding"

          # Ensure container is on web network
          docker network connect web greenacape-frontend 2>/dev/null || echo "Container already on web network"

    - name: ğŸ” Health Check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        script: |
          sleep 15
          curl -f -m 10 http://localhost:3000/ && echo "âœ… Frontend OK" || echo "âŒ Frontend FAIL"
          docker logs greenacape-frontend --tail 20